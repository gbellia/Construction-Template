!function(e){"use strict";e.AviaElementBehavior=e.AviaElementBehavior||{},e.AviaElementBehavior.wp_media=e.AviaElementBehavior.wp_media||[],e.AviaElementBehavior.wp_media_advanced=function(){var i=e("body"),t=[],a=wp.media;i.on("click",".avia-builder-prev-img-container a, .avia-builder-prev-img>img",function(i){i.preventDefault();var t=e(this).parents(".avia-form-element-container").eq(0);if(t.hasClass("avia-locked-input-element"))return!1;t.find(".button").eq(0).trigger("click")}),i.on("click",".avia-element-image .avia-delete-image",function(i){i.preventDefault();var t=e(this).addClass("avia-hidden").parents(".avia-form-element-container").eq(0);t.find(".avia-builder-prev-img").html(""),t.find("input[type=hidden]").val("").trigger("change")}),i.on("click",".avia-delete-gallery-button",function(i){i.preventDefault();var t=e(this).parents(".avia-form-element-container").eq(0);t.find(".avia-builder-prev-img-container").html(""),t.find("input[type=hidden]").val("").trigger("change")}),i.on("click",".aviabuilder-image-upload",function(i){i.preventDefault();var l=e(this),r=l.data(),n=l.closest(".avia-modal-group-wrapper");0==n.length&&(n=l.closest(".avia-form-element-container"));var d=n.find("#"+r.target),o=d.next("input"),s=n.find(".hidden-attachment-id"),p=n.find(".hidden-attachment-size"),m=n.find(".avia-builder-prev-img-container"),u=n.find(".avia-tmpl-modal-element"),v=u.html(),c=n.find(".avia-modal-group"),g=n.find(".avia-delete-image"),f=function(i,t,a){var l=[],r="image";if("html"==a.save_to)t.each(function(){var i=e(this).html();isNaN(parseInt(i,10))||l.push(i)});else{if(void 0===i)return;l=i.split(",")}if(0!=l.length&&!isNaN(parseInt(l[0],10))){void 0!==a.media_type&&(r=a.media_type);var n={orderby:"post__in",order:"ASC",type:r,perPage:-1,post__in:l},d=wp.media.query(n),o=new wp.media.model.Selection(d.models,{props:d.props.toJSON(),multiple:!0});return void 0!==a.state_edit&&l.length>0&&(a.state=a.state_edit),o}}(d.val(),s,r),y=_.random(0,1e18);e.AviaElementBehavior.wp_media.unshift(this),t[y]?t[y].open():(t[y]=wp.media({frame:r.frame,state:r.state,library:{type:"image"},button:{text:r.button},className:r.class,selection:f}),t[y].states.add([new a.controller.Library({id:"avia_insert_single",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:a.query(t[y].options.library),multiple:!1,editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0}),new a.controller.Library({id:"avia_insert_multi",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:a.query(t[y].options.library),multiple:"add",editable:!0,displayUserSettings:!1,displaySettings:!1,allowLocalEdits:!0}),new a.controller.Library({id:"avia_insert_video",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:a.query({type:"video",orderby:"date",query:!0}),multiple:!1,editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0}),new a.controller.Library({id:"avia_insert_multi_video",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:a.query({type:"video",orderby:"date",query:!0}),multiple:"add",editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0}),new a.controller.Library({id:"avia_insert_audio",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:a.query({type:"audio",orderby:"date",query:!0}),multiple:!1,editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0}),new a.controller.Library({id:"avia_insert_multi_audio",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:a.query({type:"audio",orderby:"date",query:!0}),multiple:"add",editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0})]),t[y].on("select update insert",function(i){var a,l=t[y].state();a=void 0!==i?i:l.get("selection");var n,f,h,b,_="",w=e("<div></div>");n=a.map(function(i){if(h=i.toJSON(),"url"==r.fetch)return f=l.display(i).toJSON(),void 0===h.sizes?(b=h.url,_=""):(b=h.sizes[f.size].url,_+="<span class='avia-builder-prev-img'><img src='"+b+"' /></span>",g.removeClass("avia-hidden"),s.length&&s.val(h.id),p.length&&p.val(f.size)),b;if("id"==r.fetch)return b=void 0!==h.sizes.thumbnail?h.sizes.thumbnail.url:h.url,_+="<span class='avia-builder-prev-img'><img src='"+b+"' /></span>",g.removeClass("avia-hidden"),o.length&&o.val('<img src="'+b+'" />'),h[r.fetch];if("template"==r.fetch){var t=e(v),a={id:h.id,img_fakeArg:""};if(u.hasClass("avia-copy-element-template")){t.addClass("avia-force-empty-update-value");var n=t.html().match(/element_template='(\d*)'|element_template="(\d*)"/i);null!=n&&n.length>1?a.element_template=n[1]:a.element_template=""}h.sizes&&h.sizes.thumbnail?a.img_fakeArg=h.sizes.thumbnail.url:a.img_fakeArg=h.url,a.img_fakeArg='<img src="'+a.img_fakeArg+'" title="" alt="" />';var d=e.avia_builder.update_builder_html(t,a,!1);t.find(e.avia_builder.datastorage).eq(0)[0].innerHTML=d.output,w.append(t)}else if("template_audio"==r.fetch){c.html(""),f=l.display(i).toJSON();t=e(v);(a={id:h.id,title:h.title,artist:h.artist,album:h.album,description:h.description,filelength:h.fileLength,url:h.url,filename:h.filename,icon:h.icon,img_fakeArg:h.icon,title_info:""}).img_fakeArg='<img src="'+a.img_fakeArg+'" title="'+a.title+'" alt="" />',void 0!==a.title?a.title_info+='<span class="avia-known-title">'+a.title:a.title_info+='<span class="avia-unknown-title">'+a.title,a.title_info+="</span>";d=e.avia_builder.update_builder_html(t,a,!0);t.find(e.avia_builder.datastorage).eq(0)[0].innerHTML=d.output,w.append(t)}}),d.length&&d.val(n.join(",")).trigger("change"),m.length&&m.html(_),c.length&&c.append(w.html())}),t[y].on("close",function(){_.defer(function(){e.AviaElementBehavior.wp_media.shift()})}),t[y].open())})}}(jQuery);